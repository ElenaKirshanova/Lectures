% !TeX program = xelatex
% !BIB TS-program = biber

\documentclass{beamer}

\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}

%---tikz----
\usepackage{tikz}
\usetikzlibrary{arrows, chains, matrix, positioning, scopes, patterns, shapes}
\usepackage{pgfplots, subfigure}
\usepackage{extarrows}

\usepackage[backend=biber,firstinits=true,hyperref=true,style=numeric-comp]{biblatex}

\usepackage{../beamerthemeec2020}
{\footnotesize\bibliography{../biblio}}

\title{Эллиптические кривые}
\subtitle{Лекция 2. Групповой закон}
\author{Семён Новосёлов}
\institute{БФУ им. И. Канта}
\date{2025}

\begin{document}
	
	\frame{\titlepage}
	
	\begin{frame}{Групповой закон}%{Аффинные координаты}
		\begin{center}
			$E/K: y^2 = x^3 + Ax + B$
		\end{center}
		\begin{columns}
			\begin{column}{0.5\textwidth}
				\begin{equation*}
					\begin{split}
						P_1 &= (x_1, y_1) \in E \\
						P_2 &= (x_2, y_2) \in E \\
						P_3 &= P_1 + P_2 = \left(x_3, y_3\right)
					\end{split}
				\end{equation*}
				\structure{Случай $x_1 \ne x_2$:}
				\begin{equation*}
					\begin{split}
						x_3 &= m^2 - x_1 - x_2 \\
						y_3 &= m\left( x_1 - x_3 \right) - y_1 \\
						m &= \frac{y_2 - y_1}{x_2 - x_1}
					\end{split}
				\end{equation*}
				\begin{center}
					\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
						\begin{varwidth}{\textwidth}
							\begin{center}
								I + $3$M в $K$
							\end{center}
						\end{varwidth}
					\end{tcolorbox}	
				\end{center}
				
			\end{column}
			\begin{column}{0.5\textwidth}
				\begin{figure}[h!]
					\centering
					\begin{tikzpicture}[scale=0.85]
						\begin{axis}[
							xmin=-4,
							xmax=5,
							xtick=\empty,
							ytick=\empty,
							ymin=-5,
							ymax=5,
							xlabel={$x$},
							ylabel={$y$},
							scale only axis,
							axis lines=middle,
							style={thick},
							domain=-2.279018:3,      
							samples=201,
							smooth,   
							clip=false,
							axis equal image=true,
							]
							\addplot[color=plot-blue-color] {sqrt(x^3-3*x+5)} node[right] {$E$};
							\addplot[color=plot-blue-color] {-sqrt(x^3-3*x+5)};
							\addplot[color=plot-red-color] coordinates {(-3, -0.0890722)(3, 3.06557)} node[right] {$\ell$};
							\addplot[color=plot-green-color] coordinates {(1.9, 3.5)(1.9, -3.5)};
							\draw [fill=black] (axis cs: 0.65, 1.83) circle (2pt);
							\draw[color=black] (axis cs: 1.2, 1.3) node [left]{$P_2$};
							\draw [fill=black] (axis cs: -2.26, 0.3) circle (2pt);
							\draw[color=black] (axis cs: -2.3, 0.3) node [left]{$P_1$};
							\draw [fill=black] (axis cs: 1.9, 2.5) circle (2pt);
							\draw[color=black] (axis cs: 1.9, 2.8) node [left]{$P_3'$};
							\draw [fill=black] (axis cs: 1.9, -2.5) circle (2pt);
							\draw[color=black] (axis cs: 1.9, -2.8) node [left]{$P_3$};
						\end{axis}
					\end{tikzpicture}
				\end{figure}
			\end{column}
		\end{columns}
	\end{frame}
	
	
	\begin{frame}{Групповой закон - 2}%{Аффинные координаты}
		\begin{center}
			$E/K: y^2 = x^3 + Ax + B$
		\end{center}
		\begin{columns}
			\begin{column}{0.5\textwidth}
				\begin{equation*}
					\begin{split}
						P_1 &= (x_1, y_1) \in E \\
						P_2 &= (x_2, y_2) \in E \\
						P_3 &= P_1 + P_2 = \left(x_3, y_3\right)
					\end{split}
				\end{equation*}
				\structure{Случай $x_1 = x_2$, $y_1 \neq y_2$ или $P_1 = P_2, y_1 = 0$:}
				\begin{equation*}
					{P_1} + {P_2} = \mathcal{O}
				\end{equation*}            
			\end{column}
			\begin{column}{0.5\textwidth}
				\begin{figure}[h!]
					\centering
					\begin{tikzpicture}[scale=0.85]
						\begin{axis}[
							xmin=-4,
							xmax=5,
							xtick=\empty,
							ytick=\empty,
							ymin=-5,
							ymax=5,
							xlabel={$x$},
							ylabel={$y$},
							scale only axis,
							axis lines=middle,
							style={thick},
							domain=-2.279018:3,      
							samples=201,
							smooth,   
							clip=false,
							axis equal image=true,
							]
							\addplot[color=plot-blue-color] {sqrt(x^3-3*x+5)} node[right] {$E$};
							\addplot[color=plot-blue-color] {-sqrt(x^3-3*x+5)};
							\addplot[color=plot-red-color] coordinates {(-1.0, 3.65)(-1.0, -3.65)};
							\draw [fill=black] (axis cs: -1.0, 2.65) circle (2pt);
							\draw[color=black] (axis cs: -1.0, 3.0) node [left]{$P_1$};
							\draw [fill=black] (axis cs: -1.0, -2.65) circle (2pt);
							\draw[color=black] (axis cs: -1.0, -3.0) node [left]{$P_2$};
						\end{axis}
					\end{tikzpicture}
				\end{figure}
			\end{column}
		\end{columns}
	\end{frame}
	
	\begin{frame}{Групповой закон - 3}%{Аффинные координаты}
		\begin{center}
			$E/K: y^2 = x^3 + Ax + B$
		\end{center}
		\begin{columns}
			\begin{column}{0.5\textwidth}
				\begin{equation*}
					\begin{split}
						P_1 &= (x_1, y_1) \in E \\
						P_2 &= (x_2, y_2) \in E \\
						P_3 &= P_1 + P_2 = \left(x_3, y_3\right)
					\end{split}
				\end{equation*}
				\structure{Случай ${P_1} = {P_2}$, ${y_1} \ne 0$:}
				\begin{equation*}
					\begin{split}
						x_3 &= m^2 - 2 x_1 \\
						y_3 &= m\left( x_1 - x_3 \right) - y_1\\
						m   &= \frac{3x_1^2 + A}{2 y_1} \\ 
					\end{split}
				\end{equation*}
				\begin{center}
					\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
						\begin{varwidth}{\textwidth}
							\begin{center}
								I + $4$M в $K$
							\end{center}
						\end{varwidth}
					\end{tcolorbox}	
				\end{center}
				
			\end{column}
			\begin{column}{0.5\textwidth}
				\begin{figure}[h!]
					\centering
					\begin{tikzpicture}[scale=0.85]
						\begin{axis}[
							xmin=-4,
							xmax=5,
							xtick=\empty,
							ytick=\empty,
							ymin=-5,
							ymax=5,
							xlabel={$x$},
							ylabel={$y$},
							scale only axis,
							axis lines=middle,
							style={thick},
							domain=-2.279018:3,      
							samples=201,
							smooth,   
							clip=false,
							axis equal image=true,
							]
							\addplot[color=plot-blue-color] {sqrt(x^3-3*x+5)} node[right] {$E$};
							\addplot[color=plot-blue-color] {-sqrt(x^3-3*x+5)};
							\addplot[color=plot-red-color] {2.65 + ((-3.0) + 3*(-1.2)^2)/(2*2.65) * (x - (-1.2))}  node[right] {$\ell$};
							\addplot[color=plot-green-color] coordinates {(2.5, 4.5)(2.5, -4.5)};
							\draw [fill=black] (axis cs: -1.2, 2.65) circle (2pt);
							\draw[color=black] (axis cs: -1.0, 3.0) node [left]{$P_1$};
							\draw [fill=black] (axis cs: 2.5, 3.6) circle (2pt);
							\draw[color=black] (axis cs: 2.5, 3.9) node [left]{$P_3'$};
							\draw [fill=black] (axis cs: 2.5, -3.6) circle (2pt);
							\draw[color=black] (axis cs: 2.5, -3.9) node [left]{$P_3$};
						\end{axis}
					\end{tikzpicture}
				\end{figure}
			\end{column}
		\end{columns}
	\end{frame}
	
	\begin{frame}{Групповой закон - 4}%{Аффинные координаты}
		\begin{tcolorbox}[colframe=title-and-section-color!120, colback=title-and-section-color!5, title=Теорема, center title]
			%Операция сложения на $E$ обладает свойствами:
			\begin{enumerate}
				\item $P_1 + P_2 = P_2 + P_1$ \hfill \textit{(коммутативность)}
				
				\item $P + \mathcal{O} = P$ $\forall P \in E$ \hfill \textit{($\exists$ нейтральный элемент)}
				
				\item $\forall P \in E$ $\exists P' \in E: P + P' = \mathcal{O}$ \hfill \textit{($\exists$ обратный элемент)}
				
				\item $\left( P_1 + P_2 \right) + P_3 = P_1 + \left( P_2 + P_3 \right)$ \hfill \textit{(ассоциативность)}
			\end{enumerate}
		\end{tcolorbox}
		
		\begin{itemize}
			\item $-P = (x,-y)$ для кривой в краткой форме
		\end{itemize}
		
		\structure{Вывод:} \\$
		E(K)$ -- аддитивная абелева группа
		\\
		$E(\mathbb{Q})$ -- конечно-порожденная группа
		\\
		$E(\mathbb{F}_q)$ -- конечная группа \structure{$\Rightarrow$} криптография на DLOG
	\end{frame}
	
	\begin{frame}{Быстрое умножение точки на число}
		\begin{columns}
			\begin{column}{0.5\textwidth}
				\[
				P \to \left[ k \right] \cdot P = \underbrace {P + P +  \ldots  + P}_{k{\text{-раз}}}
				\]
			\end{column}
			\begin{column}{0.5\textwidth}
				\begin{center}
					\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
						\begin{varwidth}{\textwidth}
							\begin{center}
								$k-1$ сложений (наивно)
							\end{center}
						\end{varwidth}
					\end{tcolorbox}	
				\end{center}
			\end{column}
		\end{columns}
		%
		\begin{columns}
			\begin{column}{0.5\textwidth}
				\structure{Бинарный метод:}\\
				$k = \sum\limits_{j = 0}^{\ell - 1} {{k_j}{2^j}} ,\quad {k_j} \in \left\{ {0,1} \right\}$\\
				\begin{enumerate}
					\item $Q \leftarrow \mathcal{O}$
					\item \structure{for} $j = \ell - 1$ \structure{to} $0$ \structure{by} $-1$:\\
					\quad$Q \leftarrow \left[ 2 \right]Q$ \\
					\quad \structure{if} ${k_j} = 1$:\\
					\quad\quad$Q \leftarrow Q + P$
					\item \structure{return} $Q$
				\end{enumerate}
			\end{column}
			\begin{column}{0.5\textwidth}
				\begin{center}
					\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
						\begin{varwidth}{\textwidth}
							%\begin{enumerate}
							%\item
							удвоений: $O(\lg k)$ \\
							%\item
							сложений: $\omega t(k)\sim O (\lg k)$\\
							($\omega t$ -- вес Хэмминга $k$)\\
							%\end{enumerate}
							\structure{всего:} $O\left( {\lg k} \right)$
							%\begin{center}
							%\item $O(\lg k)$ удвоений\\
							%$\omega t(k)\sim O (\lg k)$ сложений\\
							%($\omega t$~--~вес Хэмминга $k$)
							%всего:$ \Rightarrow O \left( {\lg k} \right)$ операций сложения (дублирования).
							%\end{center}
						\end{varwidth}
					\end{tcolorbox}	
				\end{center}
			\end{column}
		\end{columns}
		%\structure{Быстрое возведение в степень (бинарный метод):}
	\end{frame}
	
	\begin{frame}{Протокол Диффи -- Хеллмана}{Выработка общего секретного ключа}
		%    \begin{columns}
			%        \begin{column}{0.4\textwidth}
				%            \begin{flushright}
					%               \structure{{\Large\faUserSecret}}    
					%            \end{flushright} 
				%        \end{column}
			%        \begin{column}{0.2\textwidth}
				%            \begin{center}
					%                $\xleftrightarrow{\hspace*{0.5cm} P \in E(\mathbb{F}_q) \hspace*{0.5cm}}$
					%            \end{center}
				%        \end{column}
			%        \begin{column}{0.4\textwidth}
				%            \begin{flushleft}
					%                 \structure{{\Large\faCat}}
					%            \end{flushleft}
				%        \end{column}
			%    \end{columns}
		%    
		%    \begin{center}
			%        %\structure{{\Large\faUserSecret} $\longrightarrow$ {\Large\faCat}}
			%        %$\stackrel{P \in E(\mathbb{F}_q)}{\xleftrightarrow{\hspace*{3cm}}}$
			%        \structure{{\Large\faUserSecret}} $\xleftrightarrow{\hspace*{1cm} P \in E(\mathbb{F}_q) \hspace*{1cm}}$ \structure{{\Large\faCat}}
			%        \\
			%        \structure{$a \in \mathbb{N}$} $\xrightarrow{\hspace*{1cm} [a] P \hspace*{1cm}}$
			%        $\hspace*{1em}$
			%        \\
			%        $\hspace*{1em}$ $\xleftarrow{\hspace*{1cm} [b] P \hspace*{1cm}}$
			%          \structure{$b \in \mathbb{N}$}
			%         \\
			%    \end{center}
		%    %\begin{enumerate}
		%    %    \item
		%        %\structure{{\Large\faUserSecret} $\longrightarrow$ {\Large\faCat}}
		%    %\end{enumerate}
		%
		\begin{center}
			\input{../images/fig_dh}
		\end{center}
		\begin{itemize}
			\item Безопасность основана на сложности нахождения \structure{DLOG} (как минимум): \[(P, [n]P) \mapsto n\]
		\end{itemize}
	\end{frame}
	
	\begin{frame}{Атака ``человек посередине''\footnote{\textit{(англ.)} man in the middle (MITM)}}
		\begin{center}
			\input{../images/fig_mitm}
		\end{center}

%		\begin{itemize}
%			\item \structure{{\Large\faCheese}} \includegraphics[width=2.5em]{mouse.png}
%		\end{itemize}
	\end{frame}

%	\begin{frame}{Цифровая подпись}
%	\end{frame}
	
%	\begin{frame}{Стандарты}
%		\begin{enumerate}
%			\item EC
%		\end{enumerate}
%	\end{frame}
	
%	\begin{frame}{Пример использования обмена ключами или подписи}
%		\begin{enumerate}
%			\item TODO: скриншот сертификата, параметры
%		\end{enumerate}
%	\end{frame}
	
	\begin{frame}{Оптимизация: проективные координаты}
		\[E: Y^2 Z = X^3+ A x Z^2 + B Z^3\]
		\begin{gather*}
			P_3 = P_1 + P_2 \\
			u = Y_2 Z_1 - Y_1 Z_2\\
			v = X_2 Z_1 - X_1 Z_2 \\
			X_3 = v(\underbrace{u^2 Z_1 Z_2 - v^3 - 2 v^2 X_1 Z_2}_w), \\
			Y_3 = u(X_1 v^2 Z_2 - w) - v^3 Z_2 Y_1 \\
			Z_3 = v^3 Z_1 Z_2
		\end{gather*}
		\begin{center}
			\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
				\begin{varwidth}{\textwidth}
					$12$M (проективные) \structure{vs} I + $3$M (аффинные)
				\end{varwidth}
			\end{tcolorbox}	
		\end{center}
	\end{frame}
	
	\begin{frame}{Оптимизация: особые формы кривой}
		\structure{Кривые Монтгомери:}
		\[
		B y^2 = x^3 + A x^2 + x
		\]
		\begin{center}
			\begin{tcolorbox}[enhanced,hbox,colback=box-blue-color!15,colframe=box-blue-color,title=Сложность,center title]
				\begin{varwidth}{\textwidth}
					удвоение + сложение: $6$M + $4$S
				\end{varwidth}
			\end{tcolorbox}	
		\end{center}
		\structure{Curve25519}: $B = 1, A = 486662, q=p=2^{255} - 19$.
		
		\vspace{0.5em}
		
		\structure{Также:} кривые Эдвардса, в форме Якоби и др.
	\end{frame}
	
%	\begin{frame}{Парадигмы построения цифровой подписи}
%		содержимое...
%	\end{frame}
	
	\begin{frame}{Цифровая подпись}
		\structure{Общие параметры:} кривая $E$ над~$\mathbb{F}_q$, $P \in E(\mathbb{F}_q)$, $r = \operatorname{ord}(P)$.
		
		%\vspace{1em}
		%\structure{Подпись} := (\structure{Setup}, \structure{Sign}, \structure{Verify}).
		
		\vspace{1em}
		
		\structure{Генерация ключей \structure{\faCat}: }
		
		\begin{enumerate}
			\item секретный ключ: $a \overset{\text{\tiny\structure{\faFish}}}{\in} [1, r]$
			\item открытый ключ: $Q = [a] P$
		\end{enumerate}
		
		\vspace{1em}
		
		\structure{Подпись сообщения \structure{\footnotesize\faEnvelope}:}
		\begin{enumerate}
			\item \structure{\faCat} выбирает~$k \overset{\text{\tiny\structure{\faFish}}}{\in} [1, r]$ и вычисляет $R = [k] P  = (x, y)$
			%\item вычисляет~$s = k^{-1} (m + a x) \bmod{r}$
			\item вычисляет~$s = k^{-1} (\text{\structure{\footnotesize\faEnvelope}} + a x) \bmod{r}$
			%\item \structure{\faPaw} = $(\text{\structure{\footnotesize\faEnvelope}}, R, s)$
			\item \structure{\faPaw} = $(R, s)$
		\end{enumerate}
	\end{frame}
	
	\begin{frame}
		\structure{Проверка подписи \structure{\faPaw} = $(R, s)$:}
		\begin{enumerate}
			\item \structure{\faUserSecret} вычисляет~$u_1 = s^{-1} \text{\structure{\footnotesize\faEnvelope}} \bmod{r}$ и $u_2 = s^{-1} x \bmod{r}$
			\item $S = [u_1] P + [u_2] Q$
			\item проверяет равенство~$S = R$.
		\end{enumerate}
		
		\vspace{1em}
		\structure{Корректность:}
		%\structure{$\triangleleft$}
		%\vspace{-3em}
		\begin{align*}
			%\begin{split}
			S &= 
			[u_1] P + [u_2] Q
			=%\\&=
			[s^{-1} \text{\structure{\footnotesize\faEnvelope}}] P + [s^{-1} x] Q 
			=\\&= [s^{-1}] ([\text{\structure{\footnotesize\faEnvelope}}] P + [x a] P)
			=%\\&=
			[k] P = R
			%\end{split}
		\end{align*}
		%\structure{$\triangleright$}
		
%		\structure{$\triangleleft$}
%		$S = 
%		[u_1] P + [u_2] Q = [s^{-1} \text{\structure{\footnotesize\faEnvelope}}] P + [s^{-1} x] Q = [s^{-1}] ([\text{\structure{\footnotesize\faEnvelope}}] P + [x a] P) = [k] P = R$.
%		\structure{$\triangleright$}
		
	\end{frame}
	
	\begin{frame}{}
		\begin{itemize}
			\item используется повсеместно в составе протокола TLS
			\item используется в Bitcoin для подписи транзакций
			\item для безопасности схемы требуется ряд ограничений на параметры
			\item ECDSA / ГОСТ 34.10-2018
		\end{itemize}
	\end{frame}
	
	\begin{frame}{Проблемы реализации}
		Если использовать одно и тоже значение~$k$ для разных подписей, то можно восстановить секретный ключ.
\begin{center}
\structure{\faPaw} = $(R, s)$ \quad
\structure{\faPaw}' = $(R, s')$
\end{center}
\[
s = k^{-1} (\text{\structure{\footnotesize\faEnvelope}} + a x),\quad
s' = k^{-1} (\text{\structure{\footnotesize\faEnvelope}}' + a x)
\]
\[
s-s' = k^{-1} (\text{\structure{\footnotesize\faEnvelope}}-\text{\structure{\footnotesize\faEnvelope}}') \text{\structure{$\implies$}} k = \frac{\text{\structure{\footnotesize\faEnvelope}}-\text{\structure{\footnotesize\faEnvelope}}'}{s-s'}
\]
\begin{center}
	\structure{\boxed{a = \frac{s k - \text{\structure{\footnotesize\faEnvelope}}}{x}}}
\end{center}
\end{frame}

\begin{frame}{Проблемы реализации. Пример}
	Взлом подписей для приложений в PS3.
	
	\begin{columns}
		\begin{column}{0.6\textwidth}
			\begin{figure}
				\includegraphics[scale=0.3]{../images/ps3_example2}
				\caption*{\tiny Источник:
					\href{https://fahrplan.events.ccc.de/congress/2010/Fahrplan/attachments/1780_27c3_console_hacking_2010.pdf}{fahrplan.events.ccc.de/congress/2010/Fahrplan/attachments/1780\_27c3\_console\_hacking\_2010.pdf}
					}
			\end{figure}
		\end{column}
		
		\begin{column}{0.4\textwidth}
			\begin{figure}
				\includegraphics[scale=0.13]{../images/ps3_example1}
				\caption*{PlayStation 3}
			\end{figure}
		\end{column}
	\end{columns}

\end{frame}
	
	\begin{frame}{Литература}
		%\begin{itemize}
		%    \item TODO: литература по эффективной арифметике ЭК
		%    \item Ссылки на стандартизированные кривые исп. проективные координаты
		%\end{itemize}
		\nocite{Menezes1993}\nocite{Blake1999}\nocite{Washington2008}
		%\printbibliography
		
		\begin{enumerate}
			\item[\structure{\faBook}] Washington L.C. "Elliptic curves number theory and cryptography"%. 2ed (2008)
			\vspace{0.5em}
			
			\item[\structure{\faBook}] Menezes A. "Elliptic curve public key cryptosystems"
			\vspace{0.5em}
			
			\item[\structure{\faBook}] Blake I., Seroussi G., Smart N. "Elliptic Curves in Cryptography"
		\end{enumerate}
		
		\begin{center}
			\begin{tcolorbox}[enhanced,hbox,colback=block-green-color-bg,colframe=subsection-color!120,title=Контакты,center title]
				\begin{varwidth}{\textwidth}
					\begin{center}
						\href{mailto:snovoselov@kantiana.ru}{snovoselov@kantiana.ru}
					\end{center}
				\end{varwidth}
			\end{tcolorbox}	
		\end{center}
		
		\structure{Страница курса:}\\
		{\footnotesize
			\href{https://crypto-kantiana.com/semyon.novoselov/teaching/elliptic_curves_2025}{crypto-kantiana.com/semyon.novoselov/teaching/elliptic\_curves\_2025}
		}
		
	\end{frame}
	
\end{document}